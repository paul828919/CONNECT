generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  refresh_token_expires_in Int?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model ai_budget_alerts {
  id              String        @id @default(uuid())
  date            DateTime      @db.Date
  severity        AlertSeverity
  threshold       Int
  amountSpent     Float
  dailyLimit      Float
  percentage      Float
  alertSent       Boolean       @default(false)
  alertSentAt     DateTime?
  recipientEmails String[]
  createdAt       DateTime      @default(now())

  @@index([alertSent])
  @@index([date])
  @@index([severity])
}

model ai_cost_logs {
  id             String         @id @default(uuid())
  serviceType    AIServiceType
  userId         String?
  organizationId String?
  endpoint       String
  model          String
  inputTokens    Int
  outputTokens   Int
  totalTokens    Int
  costKRW        Float
  duration       Int
  success        Boolean        @default(true)
  errorMessage   String?
  cacheHit       Boolean        @default(false)
  createdAt      DateTime       @default(now())
  organizations  organizations? @relation(fields: [organizationId], references: [id])
  user           User?          @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([organizationId])
  @@index([serviceType])
  @@index([success])
  @@index([userId])
}

model ai_feedback {
  id             String           @id @default(uuid())
  serviceType    AIServiceType
  resourceId     String
  userId         String?
  organizationId String?
  rating         AIFeedbackRating
  comment        String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  user           User?            @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([rating])
  @@index([serviceType, resourceId])
  @@index([userId])
}

model audit_logs {
  id           String   @id @default(uuid())
  userId       String?
  action       String
  resourceType String
  resourceId   String
  purpose      String?
  ipAddress    String?
  userAgent    String?
  requestPath  String?
  createdAt    DateTime @default(now())
  user         User?    @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([createdAt])
  @@index([resourceType, resourceId])
  @@index([userId])
}

model category_performance_metrics {
  id            String   @id @default(uuid())
  category      String
  date          DateTime @db.Date
  matchCount    Int      @default(0)
  avgMatchScore Float    @default(0)
  savedRate     Float    @default(0)
  viewedRate    Float    @default(0)
  trlMatchRate  Float    @default(0)

  @@unique([category, date])
  @@index([category])
  @@index([date])
}

model consortium_members {
  id                  String              @id @default(uuid())
  consortiumId        String
  organizationId      String
  invitedById         String
  role                ConsortiumRole
  budgetShare         BigInt?
  budgetPercent       Float?
  responsibilities    String?
  status              MemberStatus        @default(INVITED)
  invitedAt           DateTime            @default(now())
  respondedAt         DateTime?
  responseMessage     String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  consortium_projects consortium_projects @relation(fields: [consortiumId], references: [id], onDelete: Cascade)
  invitedBy           User                @relation(fields: [invitedById], references: [id], onDelete: Cascade)
  organizations       organizations       @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([consortiumId, organizationId])
  @@index([consortiumId])
  @@index([organizationId])
  @@index([status])
}

model consortium_projects {
  id                 String               @id @default(uuid())
  name               String
  description        String?
  targetProgramId    String?
  leadOrganizationId String
  createdById        String
  totalBudget        BigInt?
  projectDuration    String?
  startDate          DateTime?
  endDate            DateTime?
  status             ConsortiumStatus     @default(DRAFT)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  consortium_members consortium_members[]
  createdBy          User                 @relation(fields: [createdById], references: [id], onDelete: Cascade)
  organizations      organizations        @relation(fields: [leadOrganizationId], references: [id], onDelete: Cascade)
  funding_programs   funding_programs?    @relation(fields: [targetProgramId], references: [id])

  @@index([createdAt])
  @@index([createdById])
  @@index([leadOrganizationId])
  @@index([status])
  @@index([targetProgramId])
}

model contact_requests {
  id                                                          String               @id @default(uuid())
  senderId                                                    String
  senderOrgId                                                 String
  receiverOrgId                                               String
  type                                                        ContactRequestType
  subject                                                     String
  message                                                     String
  status                                                      ContactRequestStatus @default(PENDING)
  responseMessage                                             String?
  respondedAt                                                 DateTime?
  createdAt                                                   DateTime             @default(now())
  updatedAt                                                   DateTime             @updatedAt
  organizations_contact_requests_receiverOrgIdToorganizations organizations        @relation("contact_requests_receiverOrgIdToorganizations", fields: [receiverOrgId], references: [id], onDelete: Cascade)
  sender                                                      User                 @relation(fields: [senderId], references: [id], onDelete: Cascade)
  organizations_contact_requests_senderOrgIdToorganizations   organizations        @relation("contact_requests_senderOrgIdToorganizations", fields: [senderOrgId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([receiverOrgId])
  @@index([senderId])
  @@index([senderOrgId])
  @@index([status])
}

model daily_analytics {
  id                  String   @id @default(uuid())
  date                DateTime @unique @db.Date
  totalUsers          Int      @default(0)
  activeUsers         Int      @default(0)
  newSignups          Int      @default(0)
  freeUsers           Int      @default(0)
  proUsers            Int      @default(0)
  teamUsers           Int      @default(0)
  conversionRate      Float    @default(0)
  churnCount          Int      @default(0)
  matchesGenerated    Int      @default(0)
  matchesViewed       Int      @default(0)
  matchesSaved        Int      @default(0)
  averageMatchScore   Float    @default(0)
  scrapingSuccessRate Float    @default(0)
  programsScraped     Int      @default(0)
  revenue             Int      @default(0)

  @@index([date])
}

model feedback {
  id             String           @id @default(uuid())
  userId         String?
  organizationId String?
  category       FeedbackCategory
  title          String
  description    String
  page           String?
  userAgent      String?
  screenshotUrl  String?
  priority       FeedbackPriority @default(MEDIUM)
  status         FeedbackStatus   @default(NEW)
  adminNotes     String?
  resolvedAt     DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  user           User?            @relation(fields: [userId], references: [id])

  @@index([category])
  @@index([createdAt])
  @@index([priority])
  @@index([status])
  @@index([userId])
}

model funding_matches {
  id                  String                @id @default(uuid())
  organizationId      String
  programId           String
  score               Int                   @db.SmallInt
  explanation         Json
  viewed              Boolean               @default(false)
  saved               Boolean               @default(false)
  viewedAt            DateTime?
  savedAt             DateTime?
  notificationSent    Boolean               @default(false)
  notifiedAt          DateTime?
  createdAt           DateTime              @default(now())
  organizations       organizations         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  funding_programs    funding_programs      @relation(fields: [programId], references: [id], onDelete: Cascade)
  match_notifications match_notifications[]

  @@unique([organizationId, programId])
  @@index([createdAt])
  @@index([organizationId, score])
  @@index([programId])
  @@index([saved])
  @@index([viewed])
}

model funding_programs {
  id                        String                @id @default(uuid())
  agencyId                  AgencyId
  title                     String
  description               String?
  announcementUrl           String
  targetType                OrganizationType[]
  minTrl                    Int?                  @db.SmallInt
  maxTrl                    Int?                  @db.SmallInt
  eligibilityCriteria       Json?
  budgetAmount              BigInt?
  fundingPeriod             String?
  deadline                  DateTime?
  category                  String?
  keywords                  String[]
  contentHash               String                @unique
  status                    ProgramStatus         @default(ACTIVE)
  publishedAt               DateTime?
  applicationStart          DateTime?
  scrapedAt                 DateTime
  lastCheckedAt             DateTime              @default(now())
  scrapingSource            String?
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  announcementType          AnnouncementType      @default(R_D_PROJECT)
  announcingAgency          String?
  ministry                  String?
  trlClassification         Json?
  trlConfidence             String?
  allowedBusinessStructures BusinessStructure[]
  attachmentUrls            String[]              @default([])
  trlInferred               Boolean               @default(false)
  // New Structured Eligibility Fields (Phase 1)
  requiredCertifications    String[]              @default([])
  preferredCertifications   String[]              @default([])
  requiredMinEmployees      Int?
  requiredMaxEmployees      Int?
  requiredMinRevenue        BigInt?
  requiredMaxRevenue        BigInt?
  requiredInvestmentAmount  Decimal?
  requiredOperatingYears    Int?
  maxOperatingYears         Int?
  requiresResearchInstitute Boolean               @default(false)
  eligibilityConfidence     ConfidenceLevel       @default(LOW)
  manualReviewRequired      Boolean               @default(false)
  manualReviewNotes         String?
  manualReviewCompletedAt   DateTime?
  manualReviewCompletedBy   String?
  eligibilityLastUpdated    DateTime?

  // ═══════════════════════════════════════════════════════════════
  // Semantic Sub-Domain Enrichment (Platform-Wide Matching Enhancement)
  // ═══════════════════════════════════════════════════════════════
  // Primary target industry - MORE SPECIFIC than category
  // Examples: "동물의약품", "인체의약품", "B2B SaaS", "전기차배터리", "양돈축산"
  primaryTargetIndustry     String?

  // Secondary related industries
  secondaryTargetIndustries String[]              @default([])

  // Semantic sub-domain classification (industry-specific)
  // Stored as JSON to support different structures per industry
  // BIO_HEALTH: { targetOrganism: "ANIMAL", applicationArea: "VETERINARY_PHARMA" }
  // ICT: { targetMarket: "ENTERPRISE", applicationArea: "B2B_SAAS" }
  // ENERGY: { energySource: "BATTERY", applicationArea: "ELECTRIC_VEHICLE" }
  semanticSubDomain         Json?

  // Specific technology domains (precise, not generic)
  // Examples: ["동물백신", "GMP제조"] instead of just ["바이오"]
  technologyDomainsSpecific String[]              @default([])

  // Description of ideal applicant company (Korean)
  targetCompanyProfile      String?

  // Program intent classification
  programIntent             ProgramIntent?

  // Enrichment metadata
  semanticConfidence        Float?                @default(0)
  semanticEnrichedAt        DateTime?
  semanticEnrichmentModel   String?

  consortium_projects       consortium_projects[]
  funding_matches           funding_matches[]
  scraping_job              scraping_jobs?
  eligibility_verification  eligibility_verification[]

  @@index([agencyId])
  @@index([announcementType])
  @@index([deadline])
  @@index([scrapedAt])
  @@index([status])
  @@index([targetType])
  @@index([eligibilityConfidence])
  @@index([manualReviewRequired])
  @@index([primaryTargetIndustry])
  @@index([programIntent])
}

model match_notifications {
  id              String           @id @default(uuid())
  userId          String
  matchId         String
  type            NotificationType
  title           String
  message         String
  read            Boolean          @default(false)
  readAt          DateTime?
  emailSent       Boolean          @default(false)
  emailSentAt     DateTime?
  createdAt       DateTime         @default(now())
  funding_matches funding_matches  @relation(fields: [matchId], references: [id], onDelete: Cascade)
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId, read])
}

model match_quality_logs {
  id             String   @id @default(uuid())
  matchId        String   @unique
  organizationId String
  programId      String
  category       String
  score          Int
  industryScore  Float
  trlScore       Float
  typeScore      Float
  rdScore        Float
  deadlineScore  Float
  saved          Boolean  @default(false)
  viewed         Boolean  @default(false)
  createdAt      DateTime @default(now())

  @@index([category])
  @@index([createdAt])
  @@index([organizationId])
  @@index([programId])
  @@index([score])
}

model organizations {
  id                                                             String                @id @default(uuid())
  type                                                           OrganizationType
  name                                                           String
  businessNumberEncrypted                                        String                @unique
  businessNumberHash                                             String                @unique
  businessStructure                                              BusinessStructure?
  description                                                    String?
  website                                                        String?
  logoUrl                                                        String?
  industrySector                                                 String?
  employeeCount                                                  EmployeeCountRange?
  revenueRange                                                   RevenueRange?
  rdExperience                                                   Boolean               @default(false)
  technologyReadinessLevel                                       Int?                  @db.SmallInt
  // Dual-TRL System: Target research TRL for R&D funding matching
  targetResearchTRL                                              Int?                  @db.SmallInt // Single target TRL level
  targetResearchTRLMin                                           Int?                  @db.SmallInt // Min TRL range (optional)
  targetResearchTRLMax                                           Int?                  @db.SmallInt // Max TRL range (optional)
  instituteType                                                  InstituteType?
  parentDepartment                                               String?
  researchFocusAreas                                             String[]
  annualRdBudget                                                 String?
  researcherCount                                                Int?
  keyTechnologies                                                String[]
  collaborationCount                                             Int?
  primaryContactName                                             String?
  primaryContactEmail                                            String?
  primaryContactPhone                                            String?
  address                                                        String?
  desiredConsortiumFields                                        String[]
  desiredTechnologies                                            String[]
  targetPartnerTRL                                               Int?                  @db.SmallInt
  commercializationCapabilities                                  String[]
  expectedTRLLevel                                               Int?                  @db.SmallInt
  targetOrgScale                                                 EmployeeCountRange?
  targetOrgRevenue                                               RevenueRange?
  profileCompleted                                               Boolean               @default(false)
  profileScore                                                   Int                   @default(0) @db.SmallInt
  status                                                         OrganizationStatus    @default(ACTIVE)
  verifiedAt                                                     DateTime?
  createdAt                                                      DateTime              @default(now())
  updatedAt                                                      DateTime              @updatedAt
  // Enhanced Verification Fields (Phase 1)
  certifications                                                 String[]              @default([])
  businessEstablishedDate                                        DateTime?
  investmentHistory                                              Json?
  patentCount                                                    Int?
  priorGrantWins                                                 Int?
  priorGrantTotalAmount                                          BigInt?
  rdInvestmentRatio                                              Decimal?              @db.Decimal(5, 2)
  lastFinancialYear                                              Int?
  governmentCertifications                                       String[]              @default([])
  industryAwards                                                 String[]              @default([])
  hasResearchInstitute                                           Boolean               @default(false)
  verificationDocumentsUploaded                                  Boolean               @default(false)
  verificationNotes                                              String?

  // ═══════════════════════════════════════════════════════════════
  // Semantic Sub-Domain Profile (Platform-Wide Matching Enhancement)
  // ═══════════════════════════════════════════════════════════════
  // Primary business domain - MORE SPECIFIC than industrySector
  // Examples: "동물의약품 제조", "B2B SaaS", "전기차 배터리", "양돈 축산"
  primaryBusinessDomain                                          String?

  // Semantic sub-domain classification (matches program schema)
  // BIO_HEALTH: { targetOrganism: "ANIMAL", applicationArea: "VETERINARY_PHARMA" }
  // ICT: { targetMarket: "ENTERPRISE", applicationArea: "B2B_SAAS" }
  // ENERGY: { energySource: "BATTERY", applicationArea: "ELECTRIC_VEHICLE" }
  semanticSubDomain                                              Json?

  // Specific technology domains (precise, not generic)
  // Examples: ["동물백신", "GMP제조"] instead of just ["바이오"]
  technologyDomainsSpecific                                      String[]              @default([])

  // Company profile description (auto-generated or user-provided)
  companyProfileDescription                                      String?

  // ═══════════════════════════════════════════════════════════════
  // Company Scale & Location (중소벤처기업부 Matching Enhancement)
  // ═══════════════════════════════════════════════════════════════
  // Company scale classification for 중소벤처기업부 program matching
  companyScaleType                                               CompanyScaleType?

  ai_cost_logs                                                   ai_cost_logs[]
  consortium_members                                             consortium_members[]
  consortium_projects                                            consortium_projects[]
  contact_requests_contact_requests_receiverOrgIdToorganizations contact_requests[]    @relation("contact_requests_receiverOrgIdToorganizations")
  contact_requests_contact_requests_senderOrgIdToorganizations   contact_requests[]    @relation("contact_requests_senderOrgIdToorganizations")
  funding_matches                                                funding_matches[]
  users                                                          User[]
  refundRequests                                                 RefundRequest[]
  teamInviteLinks                                                team_invite_links[]
  locations                                                      CompanyLocation[]   // 소재지 정보 (본사, 연구소, 공장)
  sme_program_matches                                            sme_program_matches[] // SME24 매칭 결과

  // ===== SME24 Certification Verification Fields =====
  // API-verified certifications from 중소벤처24 (이노비즈, 벤처, 메인비즈)
  certificationVerifiedAt    DateTime?    // Last verification timestamp
  certificationVerifyResult  Json?        // { innoBiz, venture, mainBiz } verification results

  @@index([businessNumberHash])
  @@index([profileCompleted])
  @@index([status])
  @@index([type])
  @@index([primaryBusinessDomain])
}

// ============================================================================
// Company Location (기업 소재지 정보)
// Stores multiple locations per organization for regional R&D matching
// 수도권 (Metropolitan): SEOUL, GYEONGGI, INCHEON
// 비수도권 (Non-Metropolitan): 나머지 14개 시도
// ============================================================================
model CompanyLocation {
  id              String        @id @default(cuid())
  organizationId  String
  organization    organizations @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  locationType    LocationType  // 본사, 연구소, 공장
  region          KoreanRegion  // 광역시도

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([organizationId, locationType])
  @@index([organizationId])
  @@index([region])
  @@map("company_locations")
}

model payments {
  id               String        @id @default(uuid())
  subscriptionId   String
  amount           Int
  currency         String        @default("KRW")
  status           PaymentStatus
  tossPaymentKey   String?       @unique
  tossOrderId      String?
  tossMethod       String?
  paidAt           DateTime?
  failedAt         DateTime?
  refundedAt       DateTime?
  failureReason    String?
  retryCount       Int           @default(0) @db.SmallInt
  taxInvoiceIssued Boolean       @default(false)
  taxInvoiceNumber String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  subscriptions    subscriptions @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([paidAt])
  @@index([status])
  @@index([subscriptionId])
}

model scraping_jobs {
  id                   String             @id @default(uuid())
  announcementUrl      String             @unique
  announcementTitle    String
  dateRange            String
  pageNumber           Int
  announcementIndex    Int
  detailPageData       Json
  attachmentFolder     String
  attachmentCount      Int                @default(0)
  attachmentFilenames  String[]           @default([])
  scrapingStatus       ScrapingStatus
  scrapingError        String?
  scrapedAt            DateTime           @default(now())
  processingStatus     ProcessingStatus   @default(PENDING)
  processingAttempts   Int                @default(0) @db.SmallInt
  processingError      String?
  processingWorker     String?
  processingStartedAt  DateTime?
  processedAt          DateTime?
  fundingProgramId     String?            @unique
  fundingProgram       funding_programs?  @relation(fields: [fundingProgramId], references: [id])
  contentHash          String             @unique
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  extraction_logs      extraction_logs[]

  @@index([scrapingStatus, processingStatus])
  @@index([dateRange])
  @@index([processingStatus, processingAttempts])
  @@index([createdAt])
  @@map("scraping_jobs")
}

model scraping_logs {
  id              String    @id @default(uuid())
  agencyId        AgencyId
  startedAt       DateTime
  completedAt     DateTime?
  duration        Int?
  success         Boolean
  programsFound   Int       @default(0) @db.SmallInt
  programsNew     Int       @default(0) @db.SmallInt
  programsUpdated Int       @default(0) @db.SmallInt
  error           String?
  errorDetails    Json?
  statusCode      Int?      @db.SmallInt
  userAgent       String?
  rateLimit       Boolean   @default(true)

  @@index([agencyId, startedAt])
  @@index([success])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model active_user_stats {
  id             String   @id @default(uuid())
  date           DateTime @unique @db.Date
  uniqueUsers    Int      @default(0)
  totalPageViews Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([date])
  @@map("active_user_stats")
}

model subscriptions {
  id                       String             @id @default(uuid())
  userId                   String             @unique
  plan                     SubscriptionPlan
  status                   SubscriptionStatus
  billingCycle             BillingCycle       @default(MONTHLY)
  startedAt                DateTime
  expiresAt                DateTime
  canceledAt               DateTime?
  cancellationReason       String?
  amount                   Int
  currency                 String             @default("KRW")
  paymentMethod            String?
  tossBillingKey           String?            @unique
  tossCustomerId           String?
  lastPaymentId            String?
  nextBillingDate          DateTime?
  isBetaUser               Boolean            @default(false)
  betaDiscount             Int?
  betaExpiresAt            DateTime?
  taxInvoiceEmail          String?
  taxInvoiceBusinessNumber String?
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt
  payments                 payments[]
  user                     User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([plan])
  @@index([status])
}

model unmapped_agency_detections {
  id           String    @id @default(uuid())
  ministry     String?
  agency       String?
  programId    String
  programTitle String
  detectedAt   DateTime  @default(now())
  resolved     Boolean   @default(false)
  resolvedAt   DateTime?
  category     String?

  @@unique([ministry, agency])
  @@index([detectedAt])
  @@index([programId])
  @@index([resolved])
}

model User {
  id                     String                @id @default(cuid())
  email                  String?               @unique
  password               String?
  name                   String?
  role                   UserRole              @default(USER)
  organizationId         String?
  emailVerified          DateTime?
  emailNotifications     Boolean               @default(true)
  weeklyDigest           Boolean               @default(true)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  lastLoginAt            DateTime?
  image                  String?
  lastNotificationSentAt DateTime?
  notificationSettings   Json?
  // Toss Payments customer key (UUID, persists across subscriptions)
  tossCustomerKey        String?               @unique

  // Professional profile fields for trust verification (consortium partner discovery)
  linkedinUrl            String?               // LinkedIn profile URL
  rememberUrl            String?               // 리멤버 (Remember) profile URL
  position               String?               // Job title/role (e.g., "대표", "연구책임자")
  showOnPartnerProfile   Boolean               @default(false)  // Opt-in visibility on partner search

  // UTM tracking for attribution analytics (cold email campaigns, ads, etc.)
  utmSource              String?               // e.g., "linkedin", "google", "cold_email"
  utmMedium              String?               // e.g., "email", "social", "cpc"
  utmCampaign            String?               // e.g., "jan2026_cold_email_batch1"
  utmTerm                String?               // Optional: keyword for paid search
  utmContent             String?               // Optional: differentiate ads/links

  accounts               Account[]
  ai_cost_logs           ai_cost_logs[]
  ai_feedback            ai_feedback[]
  audit_logs             audit_logs[]
  consortium_members     consortium_members[]
  consortium_projects    consortium_projects[]
  contact_requests       contact_requests[]
  feedback               feedback[]
  match_notifications    match_notifications[]
  sessions               Session[]
  subscriptions          subscriptions?
  organization           organizations?        @relation(fields: [organizationId], references: [id])
  refundRequests         RefundRequest[]       @relation("RefundRequests")
  processedRefunds       RefundRequest[]       @relation("RefundProcessedBy")
  teamInviteLinks        team_invite_links[]
  accountLinkingRequests AccountLinkingRequest[]

  @@index([email])
  @@index([organizationId])
  @@index([utmSource])     // For UTM attribution queries
  @@index([utmCampaign])   // For campaign performance analysis
  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

/// Temporary storage for OAuth account linking requests.
/// When a logged-in user wants to link a new OAuth provider,
/// we store the request here and verify it in the signIn callback.
model AccountLinkingRequest {
  id        String   @id @default(cuid())
  userId    String
  provider  String   // 'kakao' or 'naver'
  token     String   @unique // Random token for verification
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("account_linking_requests")
}

model team_invite_links {
  id             String        @id @default(uuid())
  code           String        @unique
  organizationId String
  createdById    String
  expiresAt      DateTime
  maxUses        Int           @default(5)
  usedCount      Int           @default(0)
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization   organizations @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy      User          @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([organizationId])
  @@index([isActive, expiresAt])
}

// ============================================================================
// Company Scale Classification (기업 규모별 분류)
// Based on Korean regulatory frameworks:
// - 중소기업기본법 (SME Basic Act)
// - 중소기업창업지원법 (Startup Support Act)
// - 중견기업 성장촉진 및 경쟁력 강화에 관한 특별법 (Mid-sized Enterprise Act)
// - 공정거래법 (Fair Trade Act for Large Enterprises)
// ============================================================================
enum CompanyScaleType {
  STARTUP           // 스타트업 (창업기업) - 업력 7년 이내
  SME               // 중소기업 - 중소기업기본법 해당
  MID_SIZED         // 중견기업 - 중견기업 특별법 해당
  LARGE_ENTERPRISE  // 대기업 - 공정거래법 해당
}

// ============================================================================
// Korean Administrative Regions (광역지방자치단체)
// Used for regional R&D program matching (수도권 vs 비수도권)
// ============================================================================
enum KoreanRegion {
  SEOUL             // 서울특별시
  GYEONGGI          // 경기도
  INCHEON           // 인천광역시
  BUSAN             // 부산광역시
  DAEGU             // 대구광역시
  GWANGJU           // 광주광역시
  DAEJEON           // 대전광역시
  ULSAN             // 울산광역시
  SEJONG            // 세종특별자치시
  GANGWON           // 강원특별자치도
  CHUNGBUK          // 충청북도
  CHUNGNAM          // 충청남도
  JEONBUK           // 전북특별자치도
  JEONNAM           // 전라남도
  GYEONGBUK         // 경상북도
  GYEONGNAM         // 경상남도
  JEJU              // 제주특별자치도
}

// ============================================================================
// Company Location Type (소재지 유형)
// ============================================================================
enum LocationType {
  HEADQUARTERS      // 본사
  RESEARCH_CENTER   // 연구소 (기업부설연구소)
  FACTORY           // 공장 (제조시설)
}

enum AIFeedbackRating {
  HELPFUL
  NOT_HELPFUL
}

enum AIServiceType {
  MATCH_EXPLANATION
  QA_CHAT
}

enum AgencyId {
  IITP
  KEIT
  TIPA
  KIMST
  NTIS
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}

enum AnnouncementType {
  R_D_PROJECT
  SURVEY
  EVENT
  NOTICE
  UNKNOWN
}

enum BillingCycle {
  MONTHLY
  ANNUAL
}

enum BusinessStructure {
  CORPORATION
  SOLE_PROPRIETOR
  GOVERNMENT_AGENCY
}

enum ConsortiumRole {
  LEAD
  PARTICIPANT
  SUBCONTRACTOR
}

enum ConsortiumStatus {
  DRAFT
  ACTIVE
  READY
  SUBMITTED
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

enum ContactRequestStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

enum ContactRequestType {
  COLLABORATION
  CONSORTIUM_INVITE
  RESEARCH_PARTNER
  TECHNOLOGY_TRANSFER
  OTHER
}

enum EmployeeCountRange {
  UNDER_10
  FROM_10_TO_50
  FROM_50_TO_100
  FROM_100_TO_300
  OVER_300
}

enum FeedbackCategory {
  BUG
  FEATURE_REQUEST
  POSITIVE
  COMPLAINT
  QUESTION
}

enum FeedbackPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum FeedbackStatus {
  NEW
  IN_REVIEW
  PLANNED
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum InstituteType {
  GOVERNMENT_FUNDED
  PRIVATE_RESEARCH
  UNIVERSITY_ATTACHED
}

enum MemberStatus {
  INVITED
  ACCEPTED
  DECLINED
  REMOVED
}

enum NotificationType {
  NEW_MATCH
  DEADLINE_REMINDER_7DAYS
  DEADLINE_REMINDER_3DAYS
  DEADLINE_REMINDER_1DAY
  WEEKLY_DIGEST
}

enum OrganizationStatus {
  ACTIVE
  PENDING_VERIFICATION
  SUSPENDED
  DEACTIVATED
}

enum OrganizationType {
  COMPANY
  RESEARCH_INSTITUTE
  UNIVERSITY
  PUBLIC_INSTITUTION
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum ProgramStatus {
  ACTIVE
  EXPIRED
  ARCHIVED
}

enum ProgramIntent {
  BASIC_RESEARCH
  APPLIED_RESEARCH
  COMMERCIALIZATION
  INFRASTRUCTURE
  POLICY_SUPPORT
}

enum RevenueRange {
  NONE
  UNDER_1B
  FROM_1B_TO_10B
  FROM_10B_TO_50B
  FROM_50B_TO_100B
  OVER_100B
}

enum SubscriptionPlan {
  FREE
  PRO
  TEAM
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  EXPIRED
  TRIAL
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum ScrapingStatus {
  SCRAPED
  SCRAPING_FAILED
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  SKIPPED
}

model extraction_logs {
  id                 String             @id @default(uuid())
  scrapingJobId      String
  field              ExtractionField
  value              String?
  dataSource         DataSource
  confidence         ConfidenceLevel
  extractionPattern  String?
  attemptedSources   String[]           @default([])
  failureReason      String?
  contextSnippet     String?
  createdAt          DateTime           @default(now())
  scrapingJob        scraping_jobs      @relation(fields: [scrapingJobId], references: [id], onDelete: Cascade)

  @@index([scrapingJobId])
  @@index([field])
  @@index([dataSource])
  @@index([createdAt])
}

model eligibility_verification {
  id                        String           @id @default(uuid())
  programId                 String
  extractionRun             DateTime         @default(now())
  // Extracted eligibility fields (Phase 2)
  requiredCertifications    String[]         @default([])
  preferredCertifications   String[]         @default([])
  requiredMinEmployees      Int?
  requiredMaxEmployees      Int?
  requiredMinRevenue        BigInt?
  requiredMaxRevenue        BigInt?
  requiredInvestmentAmount  Decimal?         @db.Decimal(18, 2)
  requiredOperatingYears    Int?
  maxOperatingYears         Int?
  requiresResearchInstitute Boolean          @default(false)
  // Metadata for verification and comparison
  confidence                ConfidenceLevel  @default(LOW)
  extractionMethod          String? // "ANNOUNCEMENT_FILE" or "DETAIL_PAGE"
  sourceFiles               String[]         @default([])
  extractionNotes           String? // Issues, warnings, or extraction context
  verified                  Boolean          @default(false)
  verifiedBy                String?
  verifiedAt                DateTime?
  // Comparison flags (set by comparison script)
  matchesCurrentData        Boolean? // Does this match current funding_programs data?
  improvementDetected       Boolean? // Is this better quality than current data?
  comparisonNotes           String? // Human-readable diff summary
  funding_program           funding_programs @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@index([programId])
  @@index([verified])
  @@index([confidence])
  @@index([extractionRun])
  @@index([matchesCurrentData])
}

enum ExtractionField {
  DEADLINE
  PUBLISHED_AT
  APPLICATION_START
  BUDGET
  TRL_RANGE
  ELIGIBILITY
  DESCRIPTION
  KEYWORDS
  INVESTMENT_REQUIREMENT
}

enum DataSource {
  ANNOUNCEMENT_FILE
  DETAIL_PAGE
  FAILED
}

enum ConfidenceLevel {
  HIGH
  MEDIUM
  LOW
}

enum RefundReasonCategory {
  CHANGE_OF_MIND       // 단순 변심
  SERVICE_ISSUE        // 서비스 장애/오류
  BILLING_ERROR        // 빌링 오류
  DUPLICATE_PAYMENT    // 중복 결제
  CONTRACT_MISMATCH    // 설명과 다른 서비스
  OTHER                // 기타
}

// ============================================================================
// Recommendation Event Type (개인화 이벤트 유형)
// For tracking user interactions with funding program recommendations
// ============================================================================
enum RecommendationEventType {
  IMPRESSION    // Item appeared in viewport (any visibility)
  VIEW          // High-confidence view (threshold met: 60% visible, 800ms dwell)
  CLICK         // Clicked to view details
  SAVE          // Saved/bookmarked
  UNSAVE        // Removed from saved
  DISMISS       // Explicitly dismissed
  HIDE          // "Don't show again"
}

// Cold start status for personalization
// Determines which personalization signals to use
enum ColdStartStatus {
  FULL_COLD      // < 5 high-confidence views - use popularity only
  PARTIAL_COLD   // 5-20 views, < 3 categories - limited personalization
  WARM           // > 20 views with 3+ categories - full personalization
}

enum RefundStatus {
  PENDING
  APPROVED
  PROCESSING
  COMPLETED
  REJECTED
}

// ============================================================================
// SME Program Status (중소벤처24 지원사업 상태)
// For tracking the lifecycle of SME support programs from the SME24 API
// ============================================================================
enum SMEProgramStatus {
  ACTIVE     // 접수 중 (Currently accepting applications)
  EXPIRED    // 마감 (Application deadline passed)
  ARCHIVED   // 보관 (Manually archived or hidden)
}

model RefundRequest {
  id                   String                @id @default(cuid())
  userId               String
  user                 User                  @relation("RefundRequests", fields: [userId], references: [id])
  organizationId       String?
  organization         organizations?        @relation(fields: [organizationId], references: [id])

  // Payment details
  subscriptionId       String?
  plan                 SubscriptionPlan
  billingCycle         BillingCycle
  amountPaid           Int                   // in KRW
  purchaseDate         DateTime
  contractEndDate      DateTime              // For accurate day calculation

  // Refund calculation
  usedDays             Int
  refundAmount         Int
  penalty              Int                   // 10% penalty if contractual

  // Category + Breakdown
  reasonCategory       RefundReasonCategory  @default(OTHER)
  calculationJson      Json                  @db.Json // Stores RefundCalculation object

  // Legal/policy basis
  isStatutory          Boolean               @default(false) // 법정 청약철회/계약해제 여부
  reason               String                // User-provided reason
  internalNotes        String?               // CS team notes

  // Admin tracking
  processedByAdminId   String?
  processedBy          User?                 @relation("RefundProcessedBy", fields: [processedByAdminId], references: [id])

  // Status tracking
  status               RefundStatus          @default(PENDING)
  requestedAt          DateTime              @default(now())
  approvedAt           DateTime?
  processedAt          DateTime?             // When sent to PG
  completedAt          DateTime?             // When PG confirmed
  rejectedAt           DateTime?
  rejectionReason      String?

  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt

  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@index([reasonCategory])
}

// ============================================================================
// Recommendation Events (개인화 이벤트 로그)
// ============================================================================
// Append-only event log for user interactions with funding program recommendations.
// This is the Single Source of Truth (SSOT) for all personalization signals.
//
// Design decisions:
// - eventId @unique for idempotency (client-generated UUID prevents duplicates)
// - No partitioning (conflicts with eventId unique constraint at current scale)
// - 180-day retention via TTL cron, 30-day learning window for scoring
// - Client-side throttling + Redis counters prevent DB read explosion
// ============================================================================
model recommendation_events {
  id              String    @id @default(uuid())

  // Schema version for future evolution
  schemaVersion   Int       @default(1)

  // Idempotency key (prevents duplicate events from retries)
  eventId         String    @unique  // Client-generated UUID

  // Core identifiers
  organizationId  String
  programId       String
  userId          String?
  sessionId       String

  // Event type
  eventType       RecommendationEventType

  // Context at time of event (critical for debiasing)
  position        Int       @db.SmallInt   // Position in the list (0-indexed)
  listSize        Int       @db.SmallInt   // Total items in list when event occurred
  matchScore      Int       @db.SmallInt   // Algorithm match score (0-100)

  // View quality signals (only for VIEW events)
  dwellTimeMs     Int?      // Time spent viewing (milliseconds)
  visibilityRatio Float?    // Percentage of card visible (0.0-1.0)
  scrollDepth     Float?    // Page scroll depth when viewed (0.0-1.0)

  // Source tracking
  source          String?   // "match_list", "email_digest", "search", "historical"
  deviceType      String?   // "desktop", "mobile", "tablet"

  // Timestamps (BOTH client and server) - Force UTC
  occurredAt      DateTime  // Client time in UTC (ISO8601: 2026-01-25T03:12:34.567Z)
  createdAt       DateTime  @default(now())  // Server time (when received)

  // Timezone tracking for debugging
  clientTzOffsetMin  Int?   // Client timezone offset in minutes (e.g., -540 for KST)

  // Batch tracking for debugging
  batchId         String?   // API batch identifier

  // Indexes for efficient queries
  // NOTE: No partitioning - eventId unique conflicts with partition key
  @@index([organizationId, occurredAt])           // User behavior timeline
  @@index([programId, eventType])                 // Program engagement analysis
  @@index([sessionId, programId, eventType, createdAt])  // Session-level dedupe
  @@index([eventType, occurredAt])                // Event type analytics
  @@index([createdAt])                            // Retention cleanup queries

  @@map("recommendation_events")
}

// ============================================================================
// Organization Preferences Derived (조직 선호도 파생 데이터)
// ============================================================================
// Aggregated preferences computed from recommendation_events.
// Learning window: 30 days (weighted for scoring)
// Retention: 180 days in events table (for historical analysis)
// Rebuild daily via cron: /scripts/aggregate-preferences.ts
// ============================================================================
model organization_preferences_derived {
  id              String   @id @default(uuid())
  organizationId  String   @unique

  // Category affinities (from recent saves/views, 30-day window)
  // Example: { "BIO_HEALTH": 0.72, "ICT": 0.45, "MANUFACTURING": 0.30 }
  categoryScores  Json     @default("{}")

  // Keyword affinities (normalized Korean keywords)
  // Example: { "AI": 0.8, "반도체": 0.6, "바이오": 0.55 }
  keywordScores   Json     @default("{}")

  // Ministry affinities
  // Example: { "과학기술정보통신부": 0.7, "중소벤처기업부": 0.5 }
  ministryScores  Json     @default("{}")

  // Behavioral statistics (30-day window)
  totalImpressions  Int    @default(0)
  totalViews        Int    @default(0)
  totalClicks       Int    @default(0)
  totalSaves        Int    @default(0)
  totalDismisses    Int    @default(0)

  // Position-debiased engagement rates
  // Computed with position normalization to avoid bias toward top items
  adjustedCTR       Float?   // Click-through rate (position-adjusted)
  adjustedSaveRate  Float?   // Save rate (position-adjusted)

  // Metadata
  lastComputedAt    DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([organizationId])
  @@map("organization_preferences_derived")
}

// ============================================================================
// Organization Personalization Status (조직 개인화 상태)
// ============================================================================
// Tracks cold start status for each organization.
// Used to decide which personalization signals to apply.
// ============================================================================
model organization_personalization_status {
  id               String          @id @default(uuid())
  organizationId   String          @unique

  // Cold start classification
  status           ColdStartStatus @default(FULL_COLD)

  // Event statistics (for status transitions)
  totalEvents      Int             @default(0)
  totalViews       Int             @default(0)    // High-confidence views only
  uniqueCategories Int             @default(0)    // Number of distinct categories viewed

  // Timeline
  firstEventAt     DateTime?
  lastEventAt      DateTime?

  // Metadata
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([status])
  @@index([organizationId])
  @@map("organization_personalization_status")
}

// ============================================================================
// Program Co-Occurrence (프로그램 동시 발생 통계)
// ============================================================================
// Tracks programs that are frequently saved/viewed together.
// Used for Item-Item collaborative filtering: "Users who saved X also saved Y"
//
// Computed daily via /scripts/compute-co-occurrences.ts
// Uses 30-day learning window (matches preference aggregator)
// ============================================================================
model program_co_occurrence {
  id            String   @id @default(uuid())

  // Program pair (ordered: programId1 < programId2 lexicographically)
  programId1    String
  programId2    String

  // Co-occurrence statistics
  coSaveCount   Int      @default(0)  // Times saved together by same org
  coViewCount   Int      @default(0)  // Times viewed together in same session
  coClickCount  Int      @default(0)  // Times clicked together in same session

  // Statistical confidence (based on sample size)
  // Higher confidence = more reliable signal
  confidence    Float    @default(0)

  // Timestamp
  computedAt    DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Unique constraint on program pair
  @@unique([programId1, programId2])

  // Indexes for efficient lookup
  @@index([programId1, coSaveCount(sort: Desc)])
  @@index([programId2, coSaveCount(sort: Desc)])

  @@map("program_co_occurrence")
}

// ============================================================================
// Organization Neighbors (조직 유사도)
// ============================================================================
// Top-K similar organizations based on behavioral similarity.
// NOT full O(n²) matrix - only stores top neighbors for efficiency.
//
// Used for: "Organizations similar to you also saved..."
// Computed weekly (less frequent than co-occurrence)
// ============================================================================
model organization_neighbors {
  id                String   @id @default(uuid())

  // Source organization
  organizationId    String

  // Similar organization (neighbor)
  neighborId        String

  // Similarity metrics
  similarityScore   Float    // 0.0-1.0 (1.0 = identical behavior)
  sharedSaves       Int      @default(0)  // Programs both saved
  sharedCategories  Int      @default(0)  // Categories both active in

  // Timestamp
  computedAt        DateTime @default(now())

  // Unique constraint on org pair
  @@unique([organizationId, neighborId])

  // Index for finding neighbors (ordered by similarity)
  @@index([organizationId, similarityScore(sort: Desc)])

  @@map("organization_neighbors")
}

// ============================================================================
// SME Support Programs (중소벤처24 지원사업)
// ============================================================================
// Separate table for SME24 API programs - distinct from R&D funding_programs.
// SME programs have 40+ unique eligibility fields (scale, revenue, certs, age)
// that don't exist in R&D programs, warranting schema separation.
//
// API Source: 중소벤처24 민간공고목록정보 API
// Documentation: https://www.smes.go.kr/fnct/apiReqst/extPblancInfo
// ============================================================================
model sme_programs {
  id                    String           @id @default(uuid())

  // ===== SME24 API Core Fields =====
  pblancSeq             Int              @unique  // 공고SEQ (Primary identifier from API)
  title                 String           // pblancNm (공고명)
  detailBsnsNm          String?          // 세부사업명
  description           String?          @db.Text  // policyCnts (사업개요, HTML stripped)
  supportScale          String?          @db.Text  // sportMg (지원규모)
  supportContents       String?          @db.Text  // sportCnts (지원내용)
  supportTarget         String?          @db.Text  // sportTrget (지원대상)
  applicationMethod     String?          @db.Text  // reqstRcept (신청방법)

  // ===== Organization & Contact =====
  supportInstitution    String?          // sportInsttNm (지원기관명)
  supportInstitutionCd  String?          // sportInsttCd (지원기관코드)
  contactInfo           String?          @db.Text  // refrnc (문의처)
  contactUrl            String?          // refrncUrl (문의처 홈페이지)
  contactDept           String?          // refrncDept (문의처 부서)
  contactTel            String?          // refrncTel (문의처 전화번호)
  linkedInstitution     String?          // cntcInsttNm (연계기관명)
  linkedInstitutionCd   String?          // cntcInsttCd (연계기관코드)

  // ===== URLs & Attachments =====
  detailUrl             String?          // pblancDtlUrl (상세정보경로)
  applicationUrl        String?          // reqstLinkInfo (온라인 신청 URL)
  attachmentUrls        String[]         // pblancAttach (첨부파일URL, pipe-separated → array)
  attachmentNames       String[]         // pblancAttachNm (첨부파일명)
  announcementFileUrl   String?          // pblancFileUrl (공고문 URL)
  announcementFileName  String?          // pblancFileNm (공고문 파일명)

  // ===== Dates =====
  applicationStart      DateTime?        // pblancBgnDt (신청시작일)
  applicationEnd        DateTime?        // pblancEndDt (신청마감일)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  apiCreatedAt          DateTime?        // creatDt (API 공고등록일)
  apiUpdatedAt          DateTime?        // updDt (API 수정일시)

  // ===== Program Classification =====
  bizType               String?          // 사업유형 (금융, 기술, 인력 등)
  bizTypeCd             String?          // 사업유형코드 (PC10, PC20, etc.)
  sportType             String?          // 지원유형 (창업, 기술개발, 정책자금 등)
  sportTypeCd           String?          // 지원유형코드 (RT01, RT02, etc.)
  lifeCycle             String[]         // 생애주기구분 (창업, 성장, 폐업·재기)
  lifeCycleCd           String[]         // 생애주기구분코드 (LC01, LC02, LC03)

  // ===== Target Eligibility Criteria =====
  targetRegions         String[]         // areaNm (지역명) - pipe-separated → array
  targetRegionCodes     String[]         // areaCd (지역코드) - pipe-separated → array
  targetCompanyScale    String[]         // cmpScale (기업규모) - 중소기업, 소상공인, 창업기업 등
  targetCompanyScaleCd  String[]         // cmpScaleCd (기업규모코드) - CC10, CC30, etc.
  targetSalesRange      String[]         // salsAmt (매출액) - 5억미만, 5억~10억 등
  targetSalesRangeCd    String[]         // salsAmtCd (매출액코드) - SI01, SI02, etc.
  minSalesAmount        BigInt?          // minSalsAmt (최소 매출액)
  maxSalesAmount        BigInt?          // maxSalsAmt (최대 매출액)
  targetEmployeeRange   String[]         // emplyCnt (종업원수) - 1~5명미만 등
  targetEmployeeRangeCd String[]         // emplyCntCd (종업원수코드) - EI01, EI02, etc.
  minEmployeeCount      Int?             // minEmplyCnt (최소 종업원수)
  maxEmployeeCount      Int?             // mixEmplyCnt (최대 종업원수) - Note: API typo "mix"
  targetBusinessAge     String[]         // ablbiz (업력) - 3년미만, 3~5년 등
  targetBusinessAgeCd   String[]         // ablbizCd (업력코드) - OI01, OI02, etc.
  minBusinessAge        Int?             // minAblbiz (최소 업력, 년)
  maxBusinessAge        Int?             // maxAblbiz (최대 업력, 년)
  targetCeoAge          Int?             // rpsntAge (대표자 연령)
  minCeoAge             Int?             // minRpsntAge (최소 대표자 연령)
  maxCeoAge             Int?             // maxRpsntAge (최대 대표자 연령)
  targetIndustry        String?          // induty (업종)

  // ===== Required Certifications =====
  requiredCerts         String[]         // needCrtfn (필요인증) - 이노비즈, 벤처기업 등
  requiredCertsCd       String[]         // needCrtfnCd (필요인증코드) - EC06, EC07, EC08 etc.

  // ===== Financial Details =====
  minSupportAmount      BigInt?          // minSportAmt (최소 지원금액)
  maxSupportAmount      BigInt?          // maxSportAmt (최대 지원금액)
  minInterestRate       Decimal?         @db.Decimal(5, 2)  // minInrst (최소 금리)
  maxInterestRate       Decimal?         @db.Decimal(5, 2)  // maxInrst (최대 금리)

  // ===== Special Flags =====
  isRestart             Boolean          @default(false)  // refntnYn (재창업여부)
  isPreStartup          Boolean          @default(false)  // fntnYn (예비창업여부)
  isFemaleOwner         Boolean          @default(false)  // fmleRpsntYn (여성대표여부)

  // ===== Internal Tracking =====
  status                SMEProgramStatus @default(ACTIVE)
  contentHash           String?          @unique  // For deduplication
  syncedAt              DateTime?        // Last sync timestamp

  // ===== Enrichment Fields (mirrors funding_programs for admin workflow) =====
  eligibilityConfidence     ConfidenceLevel       @default(LOW)
  manualReviewRequired      Boolean               @default(false)
  manualReviewNotes         String?
  manualReviewCompletedAt   DateTime?
  manualReviewCompletedBy   String?
  eligibilityLastUpdated    DateTime?

  // ===== Relations =====
  matches               sme_program_matches[]

  @@index([status, applicationEnd])
  @@index([bizTypeCd])
  @@index([sportTypeCd])
  @@index([targetCompanyScaleCd])
  @@index([targetRegionCodes])
  @@index([applicationEnd])
  @@index([syncedAt])
  @@map("sme_programs")
}

// ============================================================================
// SME Program Match Results (중소벤처24 매칭 결과)
// ============================================================================
// Stores match results between organizations and SME support programs.
// Uses separate eligibility logic from R&D matching (scale, revenue, certs).
//
// Eligibility Levels:
// - FULLY_ELIGIBLE: All criteria met, can apply immediately
// - CONDITIONALLY_ELIGIBLE: Most criteria met, minor issues (e.g., cert expiring)
// - INELIGIBLE: Hard requirement failed (filtered out, not stored)
// ============================================================================
model sme_program_matches {
  id                  String        @id @default(uuid())
  organizationId      String
  programId           String
  score               Int           @db.SmallInt  // 0-100 total score
  explanation         Json          // { summary, reasons, warnings, recommendations }

  // Eligibility details
  eligibilityLevel    String        // FULLY_ELIGIBLE, CONDITIONALLY_ELIGIBLE
  failedCriteria      String[]      // List of failed eligibility checks
  metCriteria         String[]      // List of met eligibility checks

  // Score breakdown (100 points total)
  scoreBreakdown      Json?         // { companyScale, revenueRange, employeeCount, businessAge, region, certifications }

  // User actions
  viewed              Boolean       @default(false)
  saved               Boolean       @default(false)
  viewedAt            DateTime?
  savedAt             DateTime?
  notificationSent    Boolean       @default(false)
  notifiedAt          DateTime?
  createdAt           DateTime      @default(now())

  // Relations
  organization        organizations @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  program             sme_programs  @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([organizationId, programId])
  @@index([organizationId, score])
  @@index([programId])
  @@index([saved])
  @@index([viewed])
  @@index([createdAt])
  @@map("sme_program_matches")
}

// ============================================================================
// Personalization Configuration (A/B Test Configs)
// ============================================================================
// Stores personalization algorithm configurations for A/B testing and
// gradual rollout. Each config defines weights, feature flags, and traffic.
//
// Usage:
// - Create multiple configs for A/B testing
// - Set trafficPercentage for gradual rollout
// - Toggle features via enableBehavioral, enableItemItemCF, etc.
// ============================================================================
model personalization_config {
  id                  String   @id @default(uuid())
  name                String   @unique

  // Weights (must sum to 1.0)
  baseScoreWeight     Float    @default(0.55)
  behavioralWeight    Float    @default(0.25)
  cfWeight            Float    @default(0.10)
  contextualWeight    Float    @default(0.10)

  // Exploration settings
  explorationSlots    Int      @default(2)
  explorationStrategy String   @default("epsilon_greedy")  // random, epsilon_greedy, ucb

  // Feature flags
  enableBehavioral    Boolean  @default(true)
  enableItemItemCF    Boolean  @default(true)
  enableContextual    Boolean  @default(true)
  enableExploration   Boolean  @default(true)

  // Rollout control
  isActive            Boolean  @default(false)
  trafficPercentage   Float?   // 0-100, null = 100%

  // Metadata
  description         String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([isActive])
  @@map("personalization_config")
}

// ============================================================================
// Personalization Metrics (Daily Aggregates)
// ============================================================================
// Stores daily aggregated metrics for monitoring personalization performance.
// Computed by daily cron job from recommendation_events.
//
// Key Metrics:
// - Volume: impressions, views, saves, dismisses
// - Quality: CTR, save rate (position-debiased)
// - UX: time to first save, dwell time, return rate
// - Exploration: separate metrics for exploration slots
// ============================================================================
model personalization_metrics {
  id                  String   @id @default(uuid())
  date                DateTime @db.Date
  configName          String   // Name of personalization_config used

  // Volume metrics
  totalImpressions    Int      @default(0)
  totalViews          Int      @default(0)
  totalClicks         Int      @default(0)
  totalSaves          Int      @default(0)
  totalDismisses      Int      @default(0)

  // Unique counts
  uniqueOrganizations Int      @default(0)
  uniquePrograms      Int      @default(0)

  // Quality metrics (position-debiased)
  adjustedCTR         Float?   // Click-through rate adjusted for position
  adjustedSaveRate    Float?   // Save rate adjusted for position
  avgPositionOfSave   Float?   // Average position where saves occur

  // Score distribution
  avgBaseScore        Float?
  avgPersonalizedScore Float?
  avgScoreLift        Float?   // personalizedScore - baseScore

  // UX metrics
  avgTimeToFirstSave  Float?   // Seconds to first save in session
  avgDwellTime        Float?   // Average view duration in ms
  returnRate24h       Float?   // % of users returning within 24h

  // Cold start breakdown
  fullColdCount       Int      @default(0)
  partialColdCount    Int      @default(0)
  warmCount           Int      @default(0)

  // Exploration metrics (separate tracking)
  explorationImpressions Int   @default(0)
  explorationClicks      Int   @default(0)
  explorationSaves       Int   @default(0)
  explorationCTR         Float?
  explorationSaveRate    Float?

  // Processing metrics
  avgProcessingTimeMs Float?   // Time to generate personalized matches
  p95ProcessingTimeMs Float?   // 95th percentile processing time
  totalMatchGenerations Int    @default(0)

  createdAt           DateTime @default(now())

  @@unique([date, configName])
  @@index([date])
  @@index([configName])
  @@map("personalization_metrics")
}
