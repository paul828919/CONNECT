generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  refresh_token_expires_in Int?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model ai_budget_alerts {
  id              String        @id @default(uuid())
  date            DateTime      @db.Date
  severity        AlertSeverity
  threshold       Int
  amountSpent     Float
  dailyLimit      Float
  percentage      Float
  alertSent       Boolean       @default(false)
  alertSentAt     DateTime?
  recipientEmails String[]
  createdAt       DateTime      @default(now())

  @@index([alertSent])
  @@index([date])
  @@index([severity])
}

model ai_cost_logs {
  id             String         @id @default(uuid())
  serviceType    AIServiceType
  userId         String?
  organizationId String?
  endpoint       String
  model          String
  inputTokens    Int
  outputTokens   Int
  totalTokens    Int
  costKRW        Float
  duration       Int
  success        Boolean        @default(true)
  errorMessage   String?
  cacheHit       Boolean        @default(false)
  createdAt      DateTime       @default(now())
  organizations  organizations? @relation(fields: [organizationId], references: [id])
  user           User?          @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([organizationId])
  @@index([serviceType])
  @@index([success])
  @@index([userId])
}

model ai_feedback {
  id             String           @id @default(uuid())
  serviceType    AIServiceType
  resourceId     String
  userId         String?
  organizationId String?
  rating         AIFeedbackRating
  comment        String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  user           User?            @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([rating])
  @@index([serviceType, resourceId])
  @@index([userId])
}

model audit_logs {
  id           String   @id @default(uuid())
  userId       String?
  action       String
  resourceType String
  resourceId   String
  purpose      String?
  ipAddress    String?
  userAgent    String?
  requestPath  String?
  createdAt    DateTime @default(now())
  user         User?    @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([createdAt])
  @@index([resourceType, resourceId])
  @@index([userId])
}

model category_performance_metrics {
  id            String   @id @default(uuid())
  category      String
  date          DateTime @db.Date
  matchCount    Int      @default(0)
  avgMatchScore Float    @default(0)
  savedRate     Float    @default(0)
  viewedRate    Float    @default(0)
  trlMatchRate  Float    @default(0)

  @@unique([category, date])
  @@index([category])
  @@index([date])
}

model consortium_members {
  id                  String              @id @default(uuid())
  consortiumId        String
  organizationId      String
  invitedById         String
  role                ConsortiumRole
  budgetShare         BigInt?
  budgetPercent       Float?
  responsibilities    String?
  status              MemberStatus        @default(INVITED)
  invitedAt           DateTime            @default(now())
  respondedAt         DateTime?
  responseMessage     String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  consortium_projects consortium_projects @relation(fields: [consortiumId], references: [id], onDelete: Cascade)
  invitedBy           User                @relation(fields: [invitedById], references: [id], onDelete: Cascade)
  organizations       organizations       @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([consortiumId, organizationId])
  @@index([consortiumId])
  @@index([organizationId])
  @@index([status])
}

model consortium_projects {
  id                 String               @id @default(uuid())
  name               String
  description        String?
  targetProgramId    String?
  leadOrganizationId String
  createdById        String
  totalBudget        BigInt?
  projectDuration    String?
  startDate          DateTime?
  endDate            DateTime?
  status             ConsortiumStatus     @default(DRAFT)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  consortium_members consortium_members[]
  createdBy          User                 @relation(fields: [createdById], references: [id], onDelete: Cascade)
  organizations      organizations        @relation(fields: [leadOrganizationId], references: [id], onDelete: Cascade)
  funding_programs   funding_programs?    @relation(fields: [targetProgramId], references: [id])

  @@index([createdAt])
  @@index([createdById])
  @@index([leadOrganizationId])
  @@index([status])
  @@index([targetProgramId])
}

model contact_requests {
  id                                                          String               @id @default(uuid())
  senderId                                                    String
  senderOrgId                                                 String
  receiverOrgId                                               String
  type                                                        ContactRequestType
  subject                                                     String
  message                                                     String
  status                                                      ContactRequestStatus @default(PENDING)
  responseMessage                                             String?
  respondedAt                                                 DateTime?
  createdAt                                                   DateTime             @default(now())
  updatedAt                                                   DateTime             @updatedAt
  organizations_contact_requests_receiverOrgIdToorganizations organizations        @relation("contact_requests_receiverOrgIdToorganizations", fields: [receiverOrgId], references: [id], onDelete: Cascade)
  sender                                                      User                 @relation(fields: [senderId], references: [id], onDelete: Cascade)
  organizations_contact_requests_senderOrgIdToorganizations   organizations        @relation("contact_requests_senderOrgIdToorganizations", fields: [senderOrgId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([receiverOrgId])
  @@index([senderId])
  @@index([senderOrgId])
  @@index([status])
}

model daily_analytics {
  id                  String   @id @default(uuid())
  date                DateTime @unique @db.Date
  totalUsers          Int      @default(0)
  activeUsers         Int      @default(0)
  newSignups          Int      @default(0)
  freeUsers           Int      @default(0)
  proUsers            Int      @default(0)
  teamUsers           Int      @default(0)
  conversionRate      Float    @default(0)
  churnCount          Int      @default(0)
  matchesGenerated    Int      @default(0)
  matchesViewed       Int      @default(0)
  matchesSaved        Int      @default(0)
  averageMatchScore   Float    @default(0)
  scrapingSuccessRate Float    @default(0)
  programsScraped     Int      @default(0)
  revenue             Int      @default(0)

  @@index([date])
}

model feedback {
  id             String           @id @default(uuid())
  userId         String?
  organizationId String?
  category       FeedbackCategory
  title          String
  description    String
  page           String?
  userAgent      String?
  screenshotUrl  String?
  priority       FeedbackPriority @default(MEDIUM)
  status         FeedbackStatus   @default(NEW)
  adminNotes     String?
  resolvedAt     DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  user           User?            @relation(fields: [userId], references: [id])

  @@index([category])
  @@index([createdAt])
  @@index([priority])
  @@index([status])
  @@index([userId])
}

model funding_matches {
  id                  String                @id @default(uuid())
  organizationId      String
  programId           String
  score               Int                   @db.SmallInt
  explanation         Json
  viewed              Boolean               @default(false)
  saved               Boolean               @default(false)
  viewedAt            DateTime?
  savedAt             DateTime?
  notificationSent    Boolean               @default(false)
  notifiedAt          DateTime?
  createdAt           DateTime              @default(now())
  organizations       organizations         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  funding_programs    funding_programs      @relation(fields: [programId], references: [id], onDelete: Cascade)
  match_notifications match_notifications[]

  @@unique([organizationId, programId])
  @@index([createdAt])
  @@index([organizationId, score])
  @@index([programId])
  @@index([saved])
  @@index([viewed])
}

model funding_programs {
  id                        String                @id @default(uuid())
  agencyId                  AgencyId
  title                     String
  description               String?
  announcementUrl           String
  targetType                OrganizationType[]
  minTrl                    Int?                  @db.SmallInt
  maxTrl                    Int?                  @db.SmallInt
  eligibilityCriteria       Json?
  budgetAmount              BigInt?
  fundingPeriod             String?
  deadline                  DateTime?
  category                  String?
  keywords                  String[]
  contentHash               String                @unique
  status                    ProgramStatus         @default(ACTIVE)
  publishedAt               DateTime?
  applicationStart          DateTime?
  scrapedAt                 DateTime
  lastCheckedAt             DateTime              @default(now())
  scrapingSource            String?
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  announcementType          AnnouncementType      @default(R_D_PROJECT)
  announcingAgency          String?
  ministry                  String?
  trlClassification         Json?
  trlConfidence             String?
  allowedBusinessStructures BusinessStructure[]
  attachmentUrls            String[]              @default([])
  trlInferred               Boolean               @default(false)
  // New Structured Eligibility Fields (Phase 1)
  requiredCertifications    String[]              @default([])
  preferredCertifications   String[]              @default([])
  requiredMinEmployees      Int?
  requiredMaxEmployees      Int?
  requiredMinRevenue        BigInt?
  requiredMaxRevenue        BigInt?
  requiredInvestmentAmount  Decimal?
  requiredOperatingYears    Int?
  maxOperatingYears         Int?
  requiresResearchInstitute Boolean               @default(false)
  eligibilityConfidence     ConfidenceLevel       @default(LOW)
  manualReviewRequired      Boolean               @default(false)
  manualReviewNotes         String?
  manualReviewCompletedAt   DateTime?
  manualReviewCompletedBy   String?
  eligibilityLastUpdated    DateTime?
  consortium_projects       consortium_projects[]
  funding_matches           funding_matches[]
  scraping_job              scraping_jobs?
  eligibility_verification  eligibility_verification[]

  @@index([agencyId])
  @@index([announcementType])
  @@index([deadline])
  @@index([scrapedAt])
  @@index([status])
  @@index([targetType])
  @@index([eligibilityConfidence])
  @@index([manualReviewRequired])
}

model match_notifications {
  id              String           @id @default(uuid())
  userId          String
  matchId         String
  type            NotificationType
  title           String
  message         String
  read            Boolean          @default(false)
  readAt          DateTime?
  emailSent       Boolean          @default(false)
  emailSentAt     DateTime?
  createdAt       DateTime         @default(now())
  funding_matches funding_matches  @relation(fields: [matchId], references: [id], onDelete: Cascade)
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId, read])
}

model match_quality_logs {
  id             String   @id @default(uuid())
  matchId        String   @unique
  organizationId String
  programId      String
  category       String
  score          Int
  industryScore  Float
  trlScore       Float
  typeScore      Float
  rdScore        Float
  deadlineScore  Float
  saved          Boolean  @default(false)
  viewed         Boolean  @default(false)
  createdAt      DateTime @default(now())

  @@index([category])
  @@index([createdAt])
  @@index([organizationId])
  @@index([programId])
  @@index([score])
}

model organizations {
  id                                                             String                @id @default(uuid())
  type                                                           OrganizationType
  name                                                           String
  businessNumberEncrypted                                        String                @unique
  businessNumberHash                                             String                @unique
  businessStructure                                              BusinessStructure?
  description                                                    String?
  website                                                        String?
  logoUrl                                                        String?
  industrySector                                                 String?
  employeeCount                                                  EmployeeCountRange?
  revenueRange                                                   RevenueRange?
  rdExperience                                                   Boolean               @default(false)
  technologyReadinessLevel                                       Int?                  @db.SmallInt
  instituteType                                                  InstituteType?
  parentDepartment                                               String?
  researchFocusAreas                                             String[]
  annualRdBudget                                                 String?
  researcherCount                                                Int?
  keyTechnologies                                                String[]
  collaborationCount                                             Int?
  primaryContactName                                             String?
  primaryContactEmail                                            String?
  primaryContactPhone                                            String?
  address                                                        String?
  desiredConsortiumFields                                        String[]
  desiredTechnologies                                            String[]
  targetPartnerTRL                                               Int?                  @db.SmallInt
  commercializationCapabilities                                  String[]
  expectedTRLLevel                                               Int?                  @db.SmallInt
  targetOrgScale                                                 EmployeeCountRange?
  targetOrgRevenue                                               RevenueRange?
  profileCompleted                                               Boolean               @default(false)
  profileScore                                                   Int                   @default(0) @db.SmallInt
  status                                                         OrganizationStatus    @default(ACTIVE)
  verifiedAt                                                     DateTime?
  createdAt                                                      DateTime              @default(now())
  updatedAt                                                      DateTime              @updatedAt
  // Enhanced Verification Fields (Phase 1)
  certifications                                                 String[]              @default([])
  businessEstablishedDate                                        DateTime?
  investmentHistory                                              Json?
  patentCount                                                    Int?
  priorGrantWins                                                 Int?
  priorGrantTotalAmount                                          BigInt?
  rdInvestmentRatio                                              Decimal?              @db.Decimal(5, 2)
  lastFinancialYear                                              Int?
  governmentCertifications                                       String[]              @default([])
  industryAwards                                                 String[]              @default([])
  hasResearchInstitute                                           Boolean               @default(false)
  verificationDocumentsUploaded                                  Boolean               @default(false)
  verificationNotes                                              String?
  ai_cost_logs                                                   ai_cost_logs[]
  consortium_members                                             consortium_members[]
  consortium_projects                                            consortium_projects[]
  contact_requests_contact_requests_receiverOrgIdToorganizations contact_requests[]    @relation("contact_requests_receiverOrgIdToorganizations")
  contact_requests_contact_requests_senderOrgIdToorganizations   contact_requests[]    @relation("contact_requests_senderOrgIdToorganizations")
  funding_matches                                                funding_matches[]
  users                                                          User[]
  refundRequests                                                 RefundRequest[]
  teamInviteLinks                                                team_invite_links[]

  @@index([businessNumberHash])
  @@index([profileCompleted])
  @@index([status])
  @@index([type])
}

model payments {
  id               String        @id @default(uuid())
  subscriptionId   String
  amount           Int
  currency         String        @default("KRW")
  status           PaymentStatus
  tossPaymentKey   String?       @unique
  tossOrderId      String?
  tossMethod       String?
  paidAt           DateTime?
  failedAt         DateTime?
  refundedAt       DateTime?
  failureReason    String?
  retryCount       Int           @default(0) @db.SmallInt
  taxInvoiceIssued Boolean       @default(false)
  taxInvoiceNumber String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  subscriptions    subscriptions @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([paidAt])
  @@index([status])
  @@index([subscriptionId])
}

model scraping_jobs {
  id                   String             @id @default(uuid())
  announcementUrl      String             @unique
  announcementTitle    String
  dateRange            String
  pageNumber           Int
  announcementIndex    Int
  detailPageData       Json
  attachmentFolder     String
  attachmentCount      Int                @default(0)
  attachmentFilenames  String[]           @default([])
  scrapingStatus       ScrapingStatus
  scrapingError        String?
  scrapedAt            DateTime           @default(now())
  processingStatus     ProcessingStatus   @default(PENDING)
  processingAttempts   Int                @default(0) @db.SmallInt
  processingError      String?
  processingWorker     String?
  processingStartedAt  DateTime?
  processedAt          DateTime?
  fundingProgramId     String?            @unique
  fundingProgram       funding_programs?  @relation(fields: [fundingProgramId], references: [id])
  contentHash          String             @unique
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  extraction_logs      extraction_logs[]

  @@index([scrapingStatus, processingStatus])
  @@index([dateRange])
  @@index([processingStatus, processingAttempts])
  @@index([createdAt])
  @@map("scraping_jobs")
}

model scraping_logs {
  id              String    @id @default(uuid())
  agencyId        AgencyId
  startedAt       DateTime
  completedAt     DateTime?
  duration        Int?
  success         Boolean
  programsFound   Int       @default(0) @db.SmallInt
  programsNew     Int       @default(0) @db.SmallInt
  programsUpdated Int       @default(0) @db.SmallInt
  error           String?
  errorDetails    Json?
  statusCode      Int?      @db.SmallInt
  userAgent       String?
  rateLimit       Boolean   @default(true)

  @@index([agencyId, startedAt])
  @@index([success])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model active_user_stats {
  id             String   @id @default(uuid())
  date           DateTime @unique @db.Date
  uniqueUsers    Int      @default(0)
  totalPageViews Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([date])
  @@map("active_user_stats")
}

model subscriptions {
  id                       String             @id @default(uuid())
  userId                   String             @unique
  plan                     SubscriptionPlan
  status                   SubscriptionStatus
  billingCycle             BillingCycle       @default(MONTHLY)
  startedAt                DateTime
  expiresAt                DateTime
  canceledAt               DateTime?
  cancellationReason       String?
  amount                   Int
  currency                 String             @default("KRW")
  paymentMethod            String?
  tossBillingKey           String?            @unique
  tossCustomerId           String?
  lastPaymentId            String?
  nextBillingDate          DateTime?
  isBetaUser               Boolean            @default(false)
  betaDiscount             Int?
  betaExpiresAt            DateTime?
  taxInvoiceEmail          String?
  taxInvoiceBusinessNumber String?
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt
  payments                 payments[]
  user                     User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([plan])
  @@index([status])
}

model unmapped_agency_detections {
  id           String    @id @default(uuid())
  ministry     String?
  agency       String?
  programId    String
  programTitle String
  detectedAt   DateTime  @default(now())
  resolved     Boolean   @default(false)
  resolvedAt   DateTime?
  category     String?

  @@unique([ministry, agency])
  @@index([detectedAt])
  @@index([programId])
  @@index([resolved])
}

model User {
  id                     String                @id @default(cuid())
  email                  String?               @unique
  password               String?
  name                   String?
  role                   UserRole              @default(USER)
  organizationId         String?
  emailVerified          DateTime?
  emailNotifications     Boolean               @default(true)
  weeklyDigest           Boolean               @default(true)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  lastLoginAt            DateTime?
  image                  String?
  lastNotificationSentAt DateTime?
  notificationSettings   Json?
  // Toss Payments customer key (UUID, persists across subscriptions)
  tossCustomerKey        String?               @unique

  // Professional profile fields for trust verification (consortium partner discovery)
  linkedinUrl            String?               // LinkedIn profile URL
  rememberUrl            String?               // 리멤버 (Remember) profile URL
  position               String?               // Job title/role (e.g., "대표", "연구책임자")
  showOnPartnerProfile   Boolean               @default(false)  // Opt-in visibility on partner search

  accounts               Account[]
  ai_cost_logs           ai_cost_logs[]
  ai_feedback            ai_feedback[]
  audit_logs             audit_logs[]
  consortium_members     consortium_members[]
  consortium_projects    consortium_projects[]
  contact_requests       contact_requests[]
  feedback               feedback[]
  match_notifications    match_notifications[]
  sessions               Session[]
  subscriptions          subscriptions?
  organization           organizations?        @relation(fields: [organizationId], references: [id])
  refundRequests         RefundRequest[]       @relation("RefundRequests")
  processedRefunds       RefundRequest[]       @relation("RefundProcessedBy")
  teamInviteLinks        team_invite_links[]
  accountLinkingRequests AccountLinkingRequest[]

  @@index([email])
  @@index([organizationId])
  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

/// Temporary storage for OAuth account linking requests.
/// When a logged-in user wants to link a new OAuth provider,
/// we store the request here and verify it in the signIn callback.
model AccountLinkingRequest {
  id        String   @id @default(cuid())
  userId    String
  provider  String   // 'kakao' or 'naver'
  token     String   @unique // Random token for verification
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("account_linking_requests")
}

model team_invite_links {
  id             String        @id @default(uuid())
  code           String        @unique
  organizationId String
  createdById    String
  expiresAt      DateTime
  maxUses        Int           @default(5)
  usedCount      Int           @default(0)
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization   organizations @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy      User          @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([organizationId])
  @@index([isActive, expiresAt])
}

enum AIFeedbackRating {
  HELPFUL
  NOT_HELPFUL
}

enum AIServiceType {
  MATCH_EXPLANATION
  QA_CHAT
}

enum AgencyId {
  IITP
  KEIT
  TIPA
  KIMST
  NTIS
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}

enum AnnouncementType {
  R_D_PROJECT
  SURVEY
  EVENT
  NOTICE
  UNKNOWN
}

enum BillingCycle {
  MONTHLY
  ANNUAL
}

enum BusinessStructure {
  CORPORATION
  SOLE_PROPRIETOR
  GOVERNMENT_AGENCY
}

enum ConsortiumRole {
  LEAD
  PARTICIPANT
  SUBCONTRACTOR
}

enum ConsortiumStatus {
  DRAFT
  ACTIVE
  READY
  SUBMITTED
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

enum ContactRequestStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

enum ContactRequestType {
  COLLABORATION
  CONSORTIUM_INVITE
  RESEARCH_PARTNER
  TECHNOLOGY_TRANSFER
  OTHER
}

enum EmployeeCountRange {
  UNDER_10
  FROM_10_TO_50
  FROM_50_TO_100
  FROM_100_TO_300
  OVER_300
}

enum FeedbackCategory {
  BUG
  FEATURE_REQUEST
  POSITIVE
  COMPLAINT
  QUESTION
}

enum FeedbackPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum FeedbackStatus {
  NEW
  IN_REVIEW
  PLANNED
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum InstituteType {
  GOVERNMENT_FUNDED
  PRIVATE_RESEARCH
  UNIVERSITY_ATTACHED
}

enum MemberStatus {
  INVITED
  ACCEPTED
  DECLINED
  REMOVED
}

enum NotificationType {
  NEW_MATCH
  DEADLINE_REMINDER_7DAYS
  DEADLINE_REMINDER_3DAYS
  DEADLINE_REMINDER_1DAY
  WEEKLY_DIGEST
}

enum OrganizationStatus {
  ACTIVE
  PENDING_VERIFICATION
  SUSPENDED
  DEACTIVATED
}

enum OrganizationType {
  COMPANY
  RESEARCH_INSTITUTE
  UNIVERSITY
  PUBLIC_INSTITUTION
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum ProgramStatus {
  ACTIVE
  EXPIRED
  ARCHIVED
}

enum RevenueRange {
  NONE
  UNDER_1B
  FROM_1B_TO_10B
  FROM_10B_TO_50B
  FROM_50B_TO_100B
  OVER_100B
}

enum SubscriptionPlan {
  FREE
  PRO
  TEAM
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  EXPIRED
  TRIAL
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum ScrapingStatus {
  SCRAPED
  SCRAPING_FAILED
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  SKIPPED
}

model extraction_logs {
  id                 String             @id @default(uuid())
  scrapingJobId      String
  field              ExtractionField
  value              String?
  dataSource         DataSource
  confidence         ConfidenceLevel
  extractionPattern  String?
  attemptedSources   String[]           @default([])
  failureReason      String?
  contextSnippet     String?
  createdAt          DateTime           @default(now())
  scrapingJob        scraping_jobs      @relation(fields: [scrapingJobId], references: [id], onDelete: Cascade)

  @@index([scrapingJobId])
  @@index([field])
  @@index([dataSource])
  @@index([createdAt])
}

model eligibility_verification {
  id                        String           @id @default(uuid())
  programId                 String
  extractionRun             DateTime         @default(now())
  // Extracted eligibility fields (Phase 2)
  requiredCertifications    String[]         @default([])
  preferredCertifications   String[]         @default([])
  requiredMinEmployees      Int?
  requiredMaxEmployees      Int?
  requiredMinRevenue        BigInt?
  requiredMaxRevenue        BigInt?
  requiredInvestmentAmount  Decimal?         @db.Decimal(18, 2)
  requiredOperatingYears    Int?
  maxOperatingYears         Int?
  requiresResearchInstitute Boolean          @default(false)
  // Metadata for verification and comparison
  confidence                ConfidenceLevel  @default(LOW)
  extractionMethod          String? // "ANNOUNCEMENT_FILE" or "DETAIL_PAGE"
  sourceFiles               String[]         @default([])
  extractionNotes           String? // Issues, warnings, or extraction context
  verified                  Boolean          @default(false)
  verifiedBy                String?
  verifiedAt                DateTime?
  // Comparison flags (set by comparison script)
  matchesCurrentData        Boolean? // Does this match current funding_programs data?
  improvementDetected       Boolean? // Is this better quality than current data?
  comparisonNotes           String? // Human-readable diff summary
  funding_program           funding_programs @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@index([programId])
  @@index([verified])
  @@index([confidence])
  @@index([extractionRun])
  @@index([matchesCurrentData])
}

enum ExtractionField {
  DEADLINE
  PUBLISHED_AT
  APPLICATION_START
  BUDGET
  TRL_RANGE
  ELIGIBILITY
  DESCRIPTION
  KEYWORDS
  INVESTMENT_REQUIREMENT
}

enum DataSource {
  ANNOUNCEMENT_FILE
  DETAIL_PAGE
  FAILED
}

enum ConfidenceLevel {
  HIGH
  MEDIUM
  LOW
}

enum RefundReasonCategory {
  CHANGE_OF_MIND       // 단순 변심
  SERVICE_ISSUE        // 서비스 장애/오류
  BILLING_ERROR        // 빌링 오류
  DUPLICATE_PAYMENT    // 중복 결제
  CONTRACT_MISMATCH    // 설명과 다른 서비스
  OTHER                // 기타
}

enum RefundStatus {
  PENDING
  APPROVED
  PROCESSING
  COMPLETED
  REJECTED
}

model RefundRequest {
  id                   String                @id @default(cuid())
  userId               String
  user                 User                  @relation("RefundRequests", fields: [userId], references: [id])
  organizationId       String?
  organization         organizations?        @relation(fields: [organizationId], references: [id])

  // Payment details
  subscriptionId       String?
  plan                 SubscriptionPlan
  billingCycle         BillingCycle
  amountPaid           Int                   // in KRW
  purchaseDate         DateTime
  contractEndDate      DateTime              // For accurate day calculation

  // Refund calculation
  usedDays             Int
  refundAmount         Int
  penalty              Int                   // 10% penalty if contractual

  // Category + Breakdown
  reasonCategory       RefundReasonCategory  @default(OTHER)
  calculationJson      Json                  @db.Json // Stores RefundCalculation object

  // Legal/policy basis
  isStatutory          Boolean               @default(false) // 법정 청약철회/계약해제 여부
  reason               String                // User-provided reason
  internalNotes        String?               // CS team notes

  // Admin tracking
  processedByAdminId   String?
  processedBy          User?                 @relation("RefundProcessedBy", fields: [processedByAdminId], references: [id])

  // Status tracking
  status               RefundStatus          @default(PENDING)
  requestedAt          DateTime              @default(now())
  approvedAt           DateTime?
  processedAt          DateTime?             // When sent to PG
  completedAt          DateTime?             // When PG confirmed
  rejectedAt           DateTime?
  rejectionReason      String?

  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt

  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@index([reasonCategory])
}
