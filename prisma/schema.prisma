generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  refresh_token_expires_in Int?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model ai_budget_alerts {
  id              String        @id @default(uuid())
  date            DateTime      @db.Date
  severity        AlertSeverity
  threshold       Int
  amountSpent     Float
  dailyLimit      Float
  percentage      Float
  alertSent       Boolean       @default(false)
  alertSentAt     DateTime?
  recipientEmails String[]
  createdAt       DateTime      @default(now())

  @@index([alertSent])
  @@index([date])
  @@index([severity])
}

model ai_cost_logs {
  id             String         @id @default(uuid())
  serviceType    AIServiceType
  userId         String?
  organizationId String?
  endpoint       String
  model          String
  inputTokens    Int
  outputTokens   Int
  totalTokens    Int
  costKRW        Float
  duration       Int
  success        Boolean        @default(true)
  errorMessage   String?
  cacheHit       Boolean        @default(false)
  createdAt      DateTime       @default(now())
  organizations  organizations? @relation(fields: [organizationId], references: [id])
  user           User?          @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([organizationId])
  @@index([serviceType])
  @@index([success])
  @@index([userId])
}

model ai_feedback {
  id             String           @id @default(uuid())
  serviceType    AIServiceType
  resourceId     String
  userId         String?
  organizationId String?
  rating         AIFeedbackRating
  comment        String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  user           User?            @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([rating])
  @@index([serviceType, resourceId])
  @@index([userId])
}

model audit_logs {
  id           String   @id @default(uuid())
  userId       String?
  action       String
  resourceType String
  resourceId   String
  purpose      String?
  ipAddress    String?
  userAgent    String?
  requestPath  String?
  createdAt    DateTime @default(now())
  user         User?    @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([createdAt])
  @@index([resourceType, resourceId])
  @@index([userId])
}

model category_performance_metrics {
  id            String   @id @default(uuid())
  category      String
  date          DateTime @db.Date
  matchCount    Int      @default(0)
  avgMatchScore Float    @default(0)
  savedRate     Float    @default(0)
  viewedRate    Float    @default(0)
  trlMatchRate  Float    @default(0)

  @@unique([category, date])
  @@index([category])
  @@index([date])
}

model consortium_members {
  id                  String              @id @default(uuid())
  consortiumId        String
  organizationId      String
  invitedById         String
  role                ConsortiumRole
  budgetShare         BigInt?
  budgetPercent       Float?
  responsibilities    String?
  status              MemberStatus        @default(INVITED)
  invitedAt           DateTime            @default(now())
  respondedAt         DateTime?
  responseMessage     String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  consortium_projects consortium_projects @relation(fields: [consortiumId], references: [id], onDelete: Cascade)
  invitedBy           User                @relation(fields: [invitedById], references: [id], onDelete: Cascade)
  organizations       organizations       @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([consortiumId, organizationId])
  @@index([consortiumId])
  @@index([organizationId])
  @@index([status])
}

model consortium_projects {
  id                 String               @id @default(uuid())
  name               String
  description        String?
  targetProgramId    String?
  leadOrganizationId String
  createdById        String
  totalBudget        BigInt?
  projectDuration    String?
  startDate          DateTime?
  endDate            DateTime?
  status             ConsortiumStatus     @default(DRAFT)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  consortium_members consortium_members[]
  createdBy          User                 @relation(fields: [createdById], references: [id], onDelete: Cascade)
  organizations      organizations        @relation(fields: [leadOrganizationId], references: [id], onDelete: Cascade)
  funding_programs   funding_programs?    @relation(fields: [targetProgramId], references: [id])

  @@index([createdAt])
  @@index([createdById])
  @@index([leadOrganizationId])
  @@index([status])
  @@index([targetProgramId])
}

model contact_requests {
  id                                                          String               @id @default(uuid())
  senderId                                                    String
  senderOrgId                                                 String
  receiverOrgId                                               String
  type                                                        ContactRequestType
  subject                                                     String
  message                                                     String
  status                                                      ContactRequestStatus @default(PENDING)
  responseMessage                                             String?
  respondedAt                                                 DateTime?
  createdAt                                                   DateTime             @default(now())
  updatedAt                                                   DateTime             @updatedAt
  organizations_contact_requests_receiverOrgIdToorganizations organizations        @relation("contact_requests_receiverOrgIdToorganizations", fields: [receiverOrgId], references: [id], onDelete: Cascade)
  sender                                                      User                 @relation(fields: [senderId], references: [id], onDelete: Cascade)
  organizations_contact_requests_senderOrgIdToorganizations   organizations        @relation("contact_requests_senderOrgIdToorganizations", fields: [senderOrgId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([receiverOrgId])
  @@index([senderId])
  @@index([senderOrgId])
  @@index([status])
}

model daily_analytics {
  id                  String   @id @default(uuid())
  date                DateTime @unique @db.Date
  totalUsers          Int      @default(0)
  activeUsers         Int      @default(0)
  newSignups          Int      @default(0)
  freeUsers           Int      @default(0)
  proUsers            Int      @default(0)
  teamUsers           Int      @default(0)
  conversionRate      Float    @default(0)
  churnCount          Int      @default(0)
  matchesGenerated    Int      @default(0)
  matchesViewed       Int      @default(0)
  matchesSaved        Int      @default(0)
  averageMatchScore   Float    @default(0)
  scrapingSuccessRate Float    @default(0)
  programsScraped     Int      @default(0)
  revenue             Int      @default(0)

  @@index([date])
}

model feedback {
  id             String           @id @default(uuid())
  userId         String?
  organizationId String?
  category       FeedbackCategory
  title          String
  description    String
  page           String?
  userAgent      String?
  screenshotUrl  String?
  priority       FeedbackPriority @default(MEDIUM)
  status         FeedbackStatus   @default(NEW)
  adminNotes     String?
  resolvedAt     DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  user           User?            @relation(fields: [userId], references: [id])

  @@index([category])
  @@index([createdAt])
  @@index([priority])
  @@index([status])
  @@index([userId])
}

model funding_matches {
  id                  String                @id @default(uuid())
  organizationId      String
  programId           String
  score               Int                   @db.SmallInt
  explanation         Json
  viewed              Boolean               @default(false)
  saved               Boolean               @default(false)
  viewedAt            DateTime?
  savedAt             DateTime?
  notificationSent    Boolean               @default(false)
  notifiedAt          DateTime?
  createdAt           DateTime              @default(now())
  organizations       organizations         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  funding_programs    funding_programs      @relation(fields: [programId], references: [id], onDelete: Cascade)
  match_notifications match_notifications[]

  @@unique([organizationId, programId])
  @@index([createdAt])
  @@index([organizationId, score])
  @@index([programId])
  @@index([saved])
  @@index([viewed])
}

model funding_programs {
  id                        String                @id @default(uuid())
  agencyId                  AgencyId
  title                     String
  description               String?
  announcementUrl           String
  targetType                OrganizationType[]
  minTrl                    Int?                  @db.SmallInt
  maxTrl                    Int?                  @db.SmallInt
  eligibilityCriteria       Json?
  budgetAmount              BigInt?
  fundingPeriod             String?
  deadline                  DateTime?
  category                  String?
  keywords                  String[]
  contentHash               String                @unique
  status                    ProgramStatus         @default(ACTIVE)
  publishedAt               DateTime?
  scrapedAt                 DateTime
  lastCheckedAt             DateTime              @default(now())
  scrapingSource            String?
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  announcementType          AnnouncementType      @default(R_D_PROJECT)
  announcingAgency          String?
  ministry                  String?
  trlClassification         Json?
  trlConfidence             String?
  allowedBusinessStructures BusinessStructure[]
  attachmentUrls            String[]              @default([])
  trlInferred               Boolean               @default(false)
  consortium_projects       consortium_projects[]
  funding_matches           funding_matches[]
  scraping_job              scraping_jobs?

  @@index([agencyId])
  @@index([announcementType])
  @@index([deadline])
  @@index([scrapedAt])
  @@index([status])
  @@index([targetType])
}

model match_notifications {
  id              String           @id @default(uuid())
  userId          String
  matchId         String
  type            NotificationType
  title           String
  message         String
  read            Boolean          @default(false)
  readAt          DateTime?
  emailSent       Boolean          @default(false)
  emailSentAt     DateTime?
  createdAt       DateTime         @default(now())
  funding_matches funding_matches  @relation(fields: [matchId], references: [id], onDelete: Cascade)
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId, read])
}

model match_quality_logs {
  id             String   @id @default(uuid())
  matchId        String   @unique
  organizationId String
  programId      String
  category       String
  score          Int
  industryScore  Float
  trlScore       Float
  typeScore      Float
  rdScore        Float
  deadlineScore  Float
  saved          Boolean  @default(false)
  viewed         Boolean  @default(false)
  createdAt      DateTime @default(now())

  @@index([category])
  @@index([createdAt])
  @@index([organizationId])
  @@index([programId])
  @@index([score])
}

model organizations {
  id                                                             String                @id @default(uuid())
  type                                                           OrganizationType
  name                                                           String
  businessNumberEncrypted                                        String                @unique
  businessNumberHash                                             String                @unique
  businessStructure                                              BusinessStructure?
  description                                                    String?
  website                                                        String?
  logoUrl                                                        String?
  industrySector                                                 String?
  employeeCount                                                  EmployeeCountRange?
  revenueRange                                                   RevenueRange?
  rdExperience                                                   Boolean               @default(false)
  technologyReadinessLevel                                       Int?                  @db.SmallInt
  instituteType                                                  InstituteType?
  researchFocusAreas                                             String[]
  annualRdBudget                                                 String?
  researcherCount                                                Int?
  keyTechnologies                                                String[]
  collaborationCount                                             Int?
  primaryContactName                                             String?
  primaryContactEmail                                            String?
  primaryContactPhone                                            String?
  address                                                        String?
  desiredConsortiumFields                                        String[]
  desiredTechnologies                                            String[]
  targetPartnerTRL                                               Int?                  @db.SmallInt
  commercializationCapabilities                                  String[]
  expectedTRLLevel                                               Int?                  @db.SmallInt
  targetOrgScale                                                 EmployeeCountRange?
  targetOrgRevenue                                               RevenueRange?
  profileCompleted                                               Boolean               @default(false)
  profileScore                                                   Int                   @default(0) @db.SmallInt
  status                                                         OrganizationStatus    @default(ACTIVE)
  verifiedAt                                                     DateTime?
  createdAt                                                      DateTime              @default(now())
  updatedAt                                                      DateTime              @updatedAt
  ai_cost_logs                                                   ai_cost_logs[]
  consortium_members                                             consortium_members[]
  consortium_projects                                            consortium_projects[]
  contact_requests_contact_requests_receiverOrgIdToorganizations contact_requests[]    @relation("contact_requests_receiverOrgIdToorganizations")
  contact_requests_contact_requests_senderOrgIdToorganizations   contact_requests[]    @relation("contact_requests_senderOrgIdToorganizations")
  funding_matches                                                funding_matches[]
  users                                                          User[]

  @@index([businessNumberHash])
  @@index([profileCompleted])
  @@index([status])
  @@index([type])
}

model payments {
  id               String        @id @default(uuid())
  subscriptionId   String
  amount           Int
  currency         String        @default("KRW")
  status           PaymentStatus
  tossPaymentKey   String?       @unique
  tossOrderId      String?
  tossMethod       String?
  paidAt           DateTime?
  failedAt         DateTime?
  refundedAt       DateTime?
  failureReason    String?
  retryCount       Int           @default(0) @db.SmallInt
  taxInvoiceIssued Boolean       @default(false)
  taxInvoiceNumber String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  subscriptions    subscriptions @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([paidAt])
  @@index([status])
  @@index([subscriptionId])
}

model scraping_jobs {
  id                   String           @id @default(uuid())
  announcementUrl      String           @unique
  announcementTitle    String
  dateRange            String
  pageNumber           Int
  announcementIndex    Int
  detailPageData       Json
  attachmentFolder     String
  attachmentCount      Int              @default(0)
  attachmentFilenames  String[]         @default([])
  scrapingStatus       ScrapingStatus
  scrapingError        String?
  scrapedAt            DateTime         @default(now())
  processingStatus     ProcessingStatus @default(PENDING)
  processingAttempts   Int              @default(0) @db.SmallInt
  processingError      String?
  processingWorker     String?
  processingStartedAt  DateTime?
  processedAt          DateTime?
  fundingProgramId     String?          @unique
  fundingProgram       funding_programs? @relation(fields: [fundingProgramId], references: [id])
  contentHash          String           @unique
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  @@index([scrapingStatus, processingStatus])
  @@index([dateRange])
  @@index([processingStatus, processingAttempts])
  @@index([createdAt])
  @@map("scraping_jobs")
}

model scraping_logs {
  id              String    @id @default(uuid())
  agencyId        AgencyId
  startedAt       DateTime
  completedAt     DateTime?
  duration        Int?
  success         Boolean
  programsFound   Int       @default(0) @db.SmallInt
  programsNew     Int       @default(0) @db.SmallInt
  programsUpdated Int       @default(0) @db.SmallInt
  error           String?
  errorDetails    Json?
  statusCode      Int?      @db.SmallInt
  userAgent       String?
  rateLimit       Boolean   @default(true)

  @@index([agencyId, startedAt])
  @@index([success])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model subscriptions {
  id                       String             @id @default(uuid())
  userId                   String             @unique
  plan                     SubscriptionPlan
  status                   SubscriptionStatus
  billingCycle             BillingCycle       @default(MONTHLY)
  startedAt                DateTime
  expiresAt                DateTime
  canceledAt               DateTime?
  cancellationReason       String?
  amount                   Int
  currency                 String             @default("KRW")
  paymentMethod            String?
  tossBillingKey           String?            @unique
  tossCustomerId           String?
  lastPaymentId            String?
  nextBillingDate          DateTime?
  isBetaUser               Boolean            @default(false)
  betaDiscount             Int?
  betaExpiresAt            DateTime?
  taxInvoiceEmail          String?
  taxInvoiceBusinessNumber String?
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt
  payments                 payments[]
  user                     User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([plan])
  @@index([status])
}

model unmapped_agency_detections {
  id           String    @id @default(uuid())
  ministry     String?
  agency       String?
  programId    String
  programTitle String
  detectedAt   DateTime  @default(now())
  resolved     Boolean   @default(false)
  resolvedAt   DateTime?
  category     String?

  @@unique([ministry, agency])
  @@index([detectedAt])
  @@index([programId])
  @@index([resolved])
}

model User {
  id                     String                @id @default(cuid())
  email                  String?               @unique
  password               String?
  name                   String?
  role                   UserRole              @default(USER)
  organizationId         String?
  emailVerified          DateTime?
  emailNotifications     Boolean               @default(true)
  weeklyDigest           Boolean               @default(true)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  lastLoginAt            DateTime?
  image                  String?
  lastNotificationSentAt DateTime?
  notificationSettings   Json?
  accounts               Account[]
  ai_cost_logs           ai_cost_logs[]
  ai_feedback            ai_feedback[]
  audit_logs             audit_logs[]
  consortium_members     consortium_members[]
  consortium_projects    consortium_projects[]
  contact_requests       contact_requests[]
  feedback               feedback[]
  match_notifications    match_notifications[]
  sessions               Session[]
  subscriptions          subscriptions?
  organization           organizations?        @relation(fields: [organizationId], references: [id])

  @@index([email])
  @@index([organizationId])
  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

enum AIFeedbackRating {
  HELPFUL
  NOT_HELPFUL
}

enum AIServiceType {
  MATCH_EXPLANATION
  QA_CHAT
}

enum AgencyId {
  IITP
  KEIT
  TIPA
  KIMST
  NTIS
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}

enum AnnouncementType {
  R_D_PROJECT
  SURVEY
  EVENT
  NOTICE
  UNKNOWN
}

enum BillingCycle {
  MONTHLY
  ANNUAL
}

enum BusinessStructure {
  CORPORATION
  SOLE_PROPRIETOR
}

enum ConsortiumRole {
  LEAD
  PARTICIPANT
  SUBCONTRACTOR
}

enum ConsortiumStatus {
  DRAFT
  ACTIVE
  READY
  SUBMITTED
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

enum ContactRequestStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

enum ContactRequestType {
  COLLABORATION
  CONSORTIUM_INVITE
  RESEARCH_PARTNER
  TECHNOLOGY_TRANSFER
  OTHER
}

enum EmployeeCountRange {
  UNDER_10
  FROM_10_TO_50
  FROM_50_TO_100
  FROM_100_TO_300
  OVER_300
}

enum FeedbackCategory {
  BUG
  FEATURE_REQUEST
  POSITIVE
  COMPLAINT
  QUESTION
}

enum FeedbackPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum FeedbackStatus {
  NEW
  IN_REVIEW
  PLANNED
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum InstituteType {
  GOVERNMENT_FUNDED
  PRIVATE_RESEARCH
  UNIVERSITY_ATTACHED
}

enum MemberStatus {
  INVITED
  ACCEPTED
  DECLINED
  REMOVED
}

enum NotificationType {
  NEW_MATCH
  DEADLINE_REMINDER_7DAYS
  DEADLINE_REMINDER_3DAYS
  DEADLINE_REMINDER_1DAY
  WEEKLY_DIGEST
}

enum OrganizationStatus {
  ACTIVE
  PENDING_VERIFICATION
  SUSPENDED
  DEACTIVATED
}

enum OrganizationType {
  COMPANY
  RESEARCH_INSTITUTE
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum ProgramStatus {
  ACTIVE
  EXPIRED
  ARCHIVED
}

enum RevenueRange {
  UNDER_1B
  FROM_1B_TO_10B
  FROM_10B_TO_50B
  FROM_50B_TO_100B
  OVER_100B
}

enum SubscriptionPlan {
  FREE
  PRO
  TEAM
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  EXPIRED
  TRIAL
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum ScrapingStatus {
  SCRAPED
  SCRAPING_FAILED
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  SKIPPED
}
