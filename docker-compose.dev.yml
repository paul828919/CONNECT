# Development Services (PostgreSQL + Redis + Next.js App)

volumes:
  postgres_dev_data:
    driver: local

services:
  # Next.js Application
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: connect_dev_app
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "3000:3000"
    environment:
      TZ: Asia/Seoul
      NODE_ENV: development
      INSTANCE_ID: app1
      DATABASE_URL: postgresql://connect:connect_dev_password@postgres:5432/connect?schema=public
      REDIS_CACHE_URL: redis://redis-cache:6379/0
      REDIS_QUEUE_URL: redis://redis-queue:6379/0
      NEXTAUTH_URL: http://localhost:3000
      NEXTAUTH_SECRET: dev-secret-change-in-production-min-32-chars
      JWT_SECRET: dev-jwt-secret-change-in-production
      # Toss Payments - Test Mode (Week 9 Phase 3)
      TOSS_CLIENT_KEY: ${TOSS_CLIENT_KEY}
      TOSS_SECRET_KEY: ${TOSS_SECRET_KEY}
      TOSS_TEST_MODE: ${TOSS_TEST_MODE:-true}
      # Encryption (PIPA Compliance)
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      # Anthropic Claude AI Configuration
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      ANTHROPIC_MODEL: ${ANTHROPIC_MODEL:-claude-sonnet-4-5-20250929}
      ANTHROPIC_MAX_TOKENS: ${ANTHROPIC_MAX_TOKENS:-4096}
      ANTHROPIC_TEMPERATURE: ${ANTHROPIC_TEMPERATURE:-0.7}
      # AI Rate Limiting & Budget
      AI_RATE_LIMIT_PER_MINUTE: ${AI_RATE_LIMIT_PER_MINUTE:-50}
      AI_DAILY_BUDGET_KRW: ${AI_DAILY_BUDGET_KRW:-50000}
      AI_CIRCUIT_BREAKER_THRESHOLD: ${AI_CIRCUIT_BREAKER_THRESHOLD:-5}
      AI_CIRCUIT_BREAKER_WINDOW: ${AI_CIRCUIT_BREAKER_WINDOW:-60000}
      AI_CIRCUIT_BREAKER_TIMEOUT: ${AI_CIRCUIT_BREAKER_TIMEOUT:-30000}
      AI_CIRCUIT_BREAKER_HALF_OPEN_MAX: ${AI_CIRCUIT_BREAKER_HALF_OPEN_MAX:-1}
      # Email Configuration (AWS SES)
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_SECURE: ${SMTP_SECURE:-false}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_FROM_EMAIL: ${SMTP_FROM_EMAIL}
      SMTP_FROM_NAME: ${SMTP_FROM_NAME:-Connect}
      SMTP_REPLY_TO: ${SMTP_REPLY_TO}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.next
    depends_on:
      postgres:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
      redis-queue:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: connect_dev_postgres
    restart: unless-stopped
    environment:
      TZ: Asia/Seoul
      POSTGRES_DB: connect
      POSTGRES_USER: connect
      POSTGRES_PASSWORD: connect_dev_password
      POSTGRES_INITDB_ARGS: "--encoding=UTF8"
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U connect -d connect"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Redis Cache
  redis-cache:
    image: redis:7-alpine
    container_name: connect_dev_redis_cache
    ports:
      - "6379:6379"
    environment:
      TZ: Asia/Seoul
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Redis Queue
  redis-queue:
    image: redis:7-alpine
    container_name: connect_dev_redis_queue
    ports:
      - "6380:6379"
    environment:
      TZ: Asia/Seoul
    command: redis-server --appendonly yes
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Scraper Service (Isolated from Next.js app)
  scraper:
    build:
      context: .
      dockerfile: Dockerfile.scraper
    container_name: connect_dev_scraper
    restart: "no"  # Manual start only
    profiles:
      - scraper  # Only start when explicitly requested
    environment:
      TZ: Asia/Seoul
      NODE_ENV: development
      DATABASE_URL: postgresql://connect:connect_dev_password@postgres:5432/connect?schema=public
      REDIS_CACHE_URL: redis://redis-cache:6379/0
      REDIS_QUEUE_URL: redis://redis-queue:6379/0
      REDIS_QUEUE_HOST: redis-queue
      REDIS_QUEUE_PORT: 6379

      # Scraping configuration
      SCRAPER_CONCURRENCY: 2
      SCRAPER_TIMEOUT: 30000
      SCRAPER_USER_AGENT: Mozilla/5.0 (compatible; ConnectBot/1.0; +https://connect.kr)

      # Anthropic Claude AI (for categorization)
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      ANTHROPIC_MODEL: ${ANTHROPIC_MODEL:-claude-sonnet-4-5-20250929}

      # Hancom Docs (HWP to PDF Converter)
      HANCOM_DOCS_URL: ${HANCOM_DOCS_URL:-https://www.hancomdocs.com/ko/}
      HANCOM_DOCS_ID: ${HANCOM_DOCS_ID}
      HANCOM_DOCS_PW: ${HANCOM_DOCS_PW}

      # Agency URLs
      IITP_URL: https://www.iitp.kr
      KEIT_URL: https://www.keit.re.kr
      TIPA_URL: https://www.tipa.or.kr
      KIMST_URL: https://www.kimst.re.kr
      NTIS_URL: https://www.ntis.go.kr

      # Rate limiting
      RATE_LIMIT_PER_MINUTE: 10
    volumes:
      - ./logs/scraper:/app/logs
      - ./data/scraper:/app/data
      - ./scripts:/app/scripts  # Mount scripts for ad-hoc runs
    depends_on:
      postgres:
        condition: service_healthy
      redis-queue:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '2.0'      # Limit to 2 CPUs
          memory: 4G       # Limit to 4GB RAM
        reservations:
          memory: 2G
